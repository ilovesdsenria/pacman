<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>HTML5 Pacman</title>
    
    <style type="text/css">
      @font-face {
	    font-family: 'BDCartoonShoutRegular';
        src: url('BD_Cartoon_Shout-webfont.ttf') format('truetype');
	    font-weight: normal;
	    font-style: normal;
      }
      html, body {
        height:100%;
        width:100%;
        margin:0;
        padding:0;
        background:#000;
        font-family:sans-serif;
        -webkit-touch-callout:none;
        -webkit-user-select:none;
        -ms-user-select:none;
        user-select:none;
      }
      #pacman {
        height:100dvh;
        width:100vw;
        margin:0;
        position:relative;
        overflow:hidden;
        touch-action:none;
      }
      #shim { 
        font-family: BDCartoonShoutRegular; 
        position:absolute;
        visibility:hidden
      }
      #controls { display:none; }
      #winOverlay {
        position:fixed;
        inset:0;
        display:none;
        align-items:center;
        justify-content:center;
        background:rgba(0,0,0,0.8);
        z-index:20;
      }
      #winOverlay .content {
        background:#111;
        color:#fff;
        padding:20px 26px;
        border-radius:10px;
        text-align:center;
        min-width:260px;
      }
      #winOverlay .content h2 { margin:0 0 10px 0; font-family: BDCartoonShoutRegular; }
      #winOverlay .content a {
        display:inline-block;
        margin:10px 0;
        color:#0bf;
      }
      #winOverlay .content button {
        background:#0a0;
        color:#fff;
        border:0;
        border-radius:6px;
        padding:8px 12px;
        cursor:pointer;
      }
    </style>

</head>

<body>
  
  <div id="shim">shim for font face</div>

  <div id="controls"></div>

  <div id="winOverlay">
    <div class="content">
      <h2>Победа!</h2>
      <p>Вы прошли первый уровень.</p>
      <a id="winAnchor" href="https://mappedlove.daniilgladysev4.workers.dev/login" target="_blank" rel="noopener noreferrer">Перейти на сайт</a>
      <div>
        <button id="restartGame">Играть снова</button>
      </div>
    </div>
  </div>

  <div id="pacman"></div>
  <script src="pacman.js"></script>
  <script src="modernizr-1.5.min.js"></script>

  <script>

    var el = document.getElementById("pacman");

    if (Modernizr.canvas && Modernizr.localstorage && 
        Modernizr.audio && (Modernizr.audio.ogg || Modernizr.audio.mp3)) {
      window.setTimeout(function () { PACMAN.init(el, "./"); }, 0);
    } else {
      el.innerHTML = "Sorry, needs a decent browser<br /><small>" + 
        "(firefox 3.6+, Chrome 4+, Opera 10+ and Safari 4+)</small>";
    }
  </script>

  <script>
    // Конфигурация спрайтов и ссылки победы (загрузите файлы на сервер и укажите пути)
    window.PACMAN_SPRITES = {
      pacman: 'photos/pacman.jpeg',
      ghostDefault: 'photos/ghost.png',
      ghosts: [
        'photos/ghost1.JPG',
        'photos/ghost2.jpg',
        'photos/ghost3.JPG',
        'photos/ghost4.JPG'
      ]
    };
    window.PACMAN_WIN_LINK = 'https://mappedlove.daniilgladysev4.workers.dev/login';

    (function(){
      // применить ссылку победы
      var a = document.getElementById('winAnchor');
      if (a && window.PACMAN_WIN_LINK) { a.href = window.PACMAN_WIN_LINK; }

      // предзагрузка картинок и установка в игру
      function loadImg(src){
        return new Promise(function(resolve){
          if (!src) return resolve(null);
          var img = new Image();
          img.onload = function(){ resolve(img); };
          img.onerror = function(){ resolve(null); };
          img.src = src;
        });
      }

      function preloadSprites(cfg){
        var ghostPromises = (cfg.ghosts || []).map(loadImg);
        return Promise.all([
          loadImg(cfg.pacman),
          loadImg(cfg.ghostDefault)
        ].concat(ghostPromises));
      }

      function applySprites(results){
        if (!window.PACMAN || !PACMAN.setSprites) return;
        var pac = results[0] || null;
        var ghostDefault = results[1] || null;
        var ghosts = results.slice(2);
        PACMAN.setSprites(pac, ghostDefault, ghosts);
      }

      var cfg = window.PACMAN_SPRITES || {};
      preloadSprites(cfg).then(applySprites);

      var restartBtn = document.getElementById('restartGame');
      if (restartBtn) {
        restartBtn.addEventListener('click', function(){
          var ov = document.getElementById('winOverlay');
          if (ov) ov.style.display = 'none';
          if (window.PACMAN && PACMAN.restart) {
            PACMAN.restart();
          }
        });
      }

      // Сенсорное управление (свайпы)
      var touchStartX = 0, touchStartY = 0, active = false;
      var threshold = 20;
      function sendDir(dx, dy){
        if (!window.PACMAN) return;
        var dir = null;
        if (Math.abs(dx) > Math.abs(dy)) {
          dir = dx > 0 ? 11 : 2; // RIGHT : LEFT
        } else {
          dir = dy > 0 ? 1 : 3; // DOWN : UP
        }
        try {
          if (PACMAN && PACMAN.user && PACMAN.user.setDue) {
            PACMAN.user.setDue(dir);
          } else if (document.dispatchEvent) {
            // fallback: synthesize key
            var key = {37:2,38:3,39:11,40:1};
          }
        } catch (e) {}
      }
      el.addEventListener('touchstart', function(e){
        if (!e.touches || !e.touches[0]) return;
        active = true;
        touchStartX = e.touches[0].clientX;
        touchStartY = e.touches[0].clientY;
        e.preventDefault();
      }, {passive:false});
      el.addEventListener('touchmove', function(e){
        if (!active || !e.touches || !e.touches[0]) return;
        var dx = e.touches[0].clientX - touchStartX;
        var dy = e.touches[0].clientY - touchStartY;
        if (Math.max(Math.abs(dx), Math.abs(dy)) > threshold) {
          sendDir(dx, dy);
          active = false;
        }
        e.preventDefault();
      }, {passive:false});
      el.addEventListener('touchend', function(){ active = false; }, {passive:true});
    })();
  </script>

</body>
</html>
